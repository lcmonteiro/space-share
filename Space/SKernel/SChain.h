/**
 * ------------------------------------------------------------------------------------------------ 
 * File:   SChain.h
 * Author: Luis Monteiro
 *
 * Created on July 19, 2017, 6:23 PM
 * ------------------------------------------------------------------------------------------------
 */
#ifndef SCHAIN_H
#define SCHAIN_H
/**
 * std
 */
#include <list>
#include <map>
#include <stdbool.h>
/**
 * ------------------------------------------------------------------------------------------------
 * Chain
 * ------------------------------------------------------------------------------------------------
 */
template<class Key, class Data>
class SChain {
    /**
     * ------------------------------------------------------------------------
     * Types
     * ------------------------------------------------------------------------
     */
    using Map       = std::map<Key, Data>;
    using List      = std::list<typename Map::iterator>;
    using Iterator  = typename List::iterator;
public:
    /**
     * ------------------------------------------------------------------------
     * Defaults
     * ------------------------------------------------------------------------
     * move constructor
     */
    SChain(SChain&& chain) = default;
    /**
     * move operator 
     */
    SChain& operator=(SChain&& chain) = default;
    /**
     * ------------------------------------------------------------------------
     * Constructor
     * ------------------------------------------------------------------------
     */
    SChain(size_t capacity = 10)
    : __map(), __list(), __capacity(capacity) {}
    /**
     * ------------------------------------------------------------------------
     * Iterators
     * ------------------------------------------------------------------------
     */
    inline Iterator begin() {
        return __list.begin();
    }
    inline Iterator end() {
        return __list.end();
    }
    inline Iterator erase(Iterator it) {
        __map.erase(*it); 
        return __list.erase(it);
    }
    /**
     * ------------------------------------------------------------------------
     * Insert document 
     * ------------------------------------------------------------------------
     */
    SChain& insert(Key k, Data&& d) {
        /**
         * insert on map
         */
        auto r = __map.emplace(k, std::move(d));
        /**
         * check insert
         */
        if(r.second) {
            /** 
             * insert on list and keep limit
             */
            for (
                __list.push_back(r.first); 
                __list.size() > __capacity; 
                __list.pop_front()
                ) {
                __map.erase(__list.front());
            }
        }
        return *this;
    }
    /**
     * ------------------------------------------------------------------------
     * Find document
     * ------------------------------------------------------------------------
     */
    inline Data& find(Key k) {
        return __map.at(k);
    }
    /**
     * ------------------------------------------------------------------------
     * Exist document
     * ------------------------------------------------------------------------
     */
    inline bool exist(Key k) {
        return __map.count(k) != 0;
    }
    /**
     * ------------------------------------------------------------------------
     * Clear document
     * ------------------------------------------------------------------------
     */
    inline void clear() {
        __map.clear();
        __list.clear();
    }
protected:
    /**
     * ------------------------------------------------------------------------
     * Variables
     * ------------------------------------------------------------------------
     **
     * map
     */
    Map __map;
    /**
     * list
     */
    List __list;
    /**
     * capacity
     */
    size_t __capacity;
};
/**
 * ------------------------------------------------------------------------------------------------
 * End
 * ------------------------------------------------------------------------------------------------
 */
#endif /* SCHAIN_H */

